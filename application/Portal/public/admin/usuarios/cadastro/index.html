<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet"
        crossorigin="anonymous">
    <link href="../../../src/style.css" rel="stylesheet" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js"
        crossorigin="anonymous"></script>
</head>

<body>
    <header>
        <div class="navbar navbar-dark bg-dark shadow-sm">
            <div class="container">
                <a href="javascript:void(0)" class="navbar-brand d-flex align-items-center">
                    <strong>Painel Administrativo</strong>
                </a>
                <span class="menuitems">
                    <a href="/admin/usuarios" class="active">Usuários</a> &nbsp;•&nbsp;
                    <a href="/admin/treinos">Treinos</a> &nbsp;•&nbsp;
                    <a href="/admin/exercicios">Exercícios</a> &nbsp;•&nbsp;
                    <a href="javascript:auth.logout()">Sair</a>
                </span>
            </div>
        </div>
    </header>
    <main>
        <section class="py-5 container">
            <div id="errormessage" style="color: red"></div>
            <form id="formsub" class="row g-3" autocomplete="off">
                <div class="col-9">
                    <label for="inputName" class="form-label">Nome</label>
                    <input type="text" class="form-control" id="inputName" placeholder="" autocomplete="off">
                </div>
                <div class="col-3">
                    <label for="inputPerfil" class="form-label">Perfil</label>
                    <select class="form-select" aria-label="" id="inputPerfil">
                        <option value="aluno">Aluno</option>
                        <option value="admin">Adminitrador</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label for="inputEmail4" class="form-label">E-mail</label>
                    <input name="email" type="text" class="form-control" id="inputEmail" placeholder=""
                        autocomplete="off">
                </div>
                <div class="col-md-6">
                    <label for="inputPassword" class="form-label">Senha</label>
                    <input type="password" class="form-control" id="inputPassword" placeholder=""
                        autocomplete="new-password">
                </div>
                <div class="col-md-9" id="divtreinosel">
                    <label for="inputTreino" class="form-label">Treino Atual</label>
                </div>
                <div class="col-md-3">
                    <label for="inputTreinoExpiracao" class="form-label">Válido Até</label>
                    <input type="text" class="form-control" id="inputTreinoExpiracao" autocomplete="off" />
                </div>
                <div class="col-12">
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </section>
    </main>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="../../../src/jquery.mask.js"></script>
    <script src="../../../src/system.js"></script>
    <script>
        currentUserId = "";

        function FormataStringData (data) {
            var dia  = data.split("/")[0];
            var mes  = data.split("/")[1];
            var ano  = data.split("/")[2];

            return ano + '-' + ("0"+mes).slice(-2) + '-' + ("0"+dia).slice(-2);
        }

        function changeQueryString(searchString, documentTitle){      
            documentTitle = typeof documentTitle !== 'undefined' ? documentTitle : document.title;      
            var urlSplit=( window.location.href ).split( "?" );      
            var obj = { Title: documentTitle, Url: urlSplit[0] + searchString };      
            history.pushState(obj, obj.Title, obj.Url);      
        }

        $(function () {
            $('#inputTreinoExpiracao').mask('00/00/0000', { placeholder: "__/__/____", selectOnFocus: true });

            componentTreinos = "";
            $.ajax({
                method: "GET",
                url: "http://localhost:60002/v1/treino",
                cache: false,
                processData: false,
                contentType: 'application/json',
                headers: {
                    "Authorization": auth.getUserData().jwt
                },
                async: false
            }).done(function (result) {
                componentTreinos = `<select class="form-select" id="inputTreino">`;
                // componentTreinos += `<option value=""></option>`;
                $.each(result.treinos, function (c, e) {
                    componentTreinos += `<option value="`+e.id+`">`+e.nome+`</option>`;
                });
                componentTreinos += `</select>`;
                $("#divtreinosel").append(componentTreinos);
            });

            var queries = {};
            $.each(document.location.search.substr(1).split('&'), function (c, q) {
                var i = q.split('=');
                if (!i[0]) {
                    return;
                }
                queries[i[0].toString()] = i[1].toString();
            });

            if (queries && queries.user) {
                currentUserId = queries.user;

                $(function () {
                    $.ajax({
                        method: "GET",
                        url: "http://localhost:60001/v1/user/" + currentUserId,
                        cache: false,
                        processData: false,
                        contentType: 'application/json',
                        headers: {
                            "Authorization": auth.getUserData().jwt
                        },
                    }).done(function (result) {
                        $("#inputName").val(result.user.nome);
                        $("#inputEmail").val(result.user.email);
                        $("#inputPassword").val(result.user.senha);
                        $("#inputPerfil").val(result.user.perfil);
                    });

                    $.ajax({
                        method: "GET",
                        url: "http://localhost:60002/v1/aluno/" + currentUserId + "/treino",
                        cache: false,
                        processData: false,
                        contentType: 'application/json',
                        headers: {
                            "Authorization": auth.getUserData().jwt
                        },
                    }).done(function (result) {
                        if (result.alunoTreino) {
                            $("#inputTreino").val(result.alunoTreino.treinoId);
                            d1 = result.alunoTreino.expiracao.split(" ")[0].split("-")
                            $("#inputTreinoExpiracao").val(d1[2]+"/"+d1[1]+"/"+d1[0]);
                        }
                    });
                });
            }
        });

        $("#formsub").on("submit", function (e) {
            e.preventDefault();
            $("#errormessage").html("");
            $.ajax({
                method: currentUserId ? "PUT" : "POST",
                url: "http://localhost:60001/v1/user/" + currentUserId,
                data: JSON.stringify({
                    "nome": $("#inputName").val(),
                    "email": $("#inputEmail").val(),
                    "senha": $("#inputPassword").val(),
                    "perfil": $("#inputPerfil").val()
                }),
                cache: false,
                processData: false,
                contentType: 'application/json',
                headers: {
                    "Authorization": auth.getUserData().jwt
                },
            }).done(function (result) {
                currentUserId = result.user.id;
                changeQueryString("?user="+result.user.id);

                $.ajax({
                    method: "POST",
                    url: "http://localhost:60002/v1/aluno/" + result.user.id + "/treino",
                    data: JSON.stringify({
                        "treinoId": $("#inputTreino").val(),
                        "expiracao": $("#inputTreinoExpiracao").val() ? FormataStringData($("#inputTreinoExpiracao").val()) : null,
                    }),
                    cache: false,
                    processData: false,
                    contentType: 'application/json',
                    headers: {
                        "Authorization": auth.getUserData().jwt
                    },
                }).done(function (result) {
                    window.location = "/admin/usuarios"
                }).fail(function (result) {
                    $("#errormessage").html(result.responseJSON.errors[0].message);
                });

            }).fail(function (result) {
                $("#errormessage").html(result.responseJSON.errors[0].message);
            });
        });
    </script>
</body>

</html>