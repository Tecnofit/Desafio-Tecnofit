<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet"
        crossorigin="anonymous">
    <link href="../../../src/style.css" rel="stylesheet" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js"
        crossorigin="anonymous"></script>
</head>

<body>
    <header>
        <div class="navbar navbar-dark bg-dark shadow-sm">
            <div class="container">
                <a href="javascript:void(0)" class="navbar-brand d-flex align-items-center">
                    <strong>Painel Administrativo</strong>
                </a>
                <span class="menuitems">
                    <a href="/admin/usuarios">Usuários</a> &nbsp;•&nbsp;
                    <a href="/admin/treinos" class="active">Treinos</a> &nbsp;•&nbsp;
                    <a href="/admin/exercicios">Exercícios</a> &nbsp;•&nbsp;
                    <a href="javascript:auth.logout()">Sair</a>
                </span>
            </div>
        </div>
    </header>
    <main>
        <section class="py-5 container">
            <div id="errormessage" style="color: red"></div>
            <form id="formsub" class="row g-3" autocomplete="off">
                <div class="col-12">
                    <label for="inputName" class="form-label">Nome</label>
                    <input type="text" class="form-control form-control-sm" id="inputName" placeholder="" autocomplete="off">
                </div>
                <div class="col-12">
                    <label for="inputDescricao" class="form-label">Descricao</label>
                    <textarea name="email" type="text" class="form-control form-control" id="inputDescricao" placeholder=""
                        autocomplete="off"></textarea>
                </div>

                <div class="col-12" id="exercicios">
                    <table class="table table-sm table  table-striped table-hover table-borderless">
                        <thead>
                            <tr>
                                <th scope="col">Exercício</th>
                                <th scope="col" style="width: 300px;">Repetições</th>
                                <!-- <th scope="col"></th> -->
                            </tr>
                        </thead>
                        <tbody id="listitems">

                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3" class="text-end">
                                    <a href="javascript:addRowExercicio()" class="btn btn-sm btn-primary">+</a>
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <div class="col-12">
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>

        </section>
    </main>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="../../../src/system.js"></script>
    <script>
        let currentTreinoId = "";
        let componentExercicios;

        $(function () {
            var queries = {};
            $.each(document.location.search.substr(1).split('&'), function (c, q) {
                var i = q.split('=');
                if (!i[0]) {
                    return;
                }
                queries[i[0].toString()] = i[1].toString();
            });

            $.ajax({
                method: "GET",
                url: "http://localhost:60002/v1/exercicio/",
                cache: false,
                processData: false,
                contentType: 'application/json',
                headers: {
                    "Authorization": auth.getUserData().jwt
                },
                async: false
            }).done(function (result) {
                componentExercicios = `<select class="form-select form-select-sm" name="exercicioId[]" id="inputPerfil">`;
                componentExercicios += `<option value=""></option>`;
                $.each(result.exercicios, function (c, e) {
                    componentExercicios += `<option value="`+e.id+`">`+e.nome+`</option>`;
                });
                componentExercicios += `</select>`;
            });

            if (queries && queries.treino) {
                currentTreinoId = queries.treino;

                $.ajax({
                    method: "GET",
                    url: "http://localhost:60002/v1/treino/" + currentTreinoId,
                    cache: false,
                    processData: false,
                    contentType: 'application/json',
                    headers: {
                        "Authorization": auth.getUserData().jwt
                    }
                }).done(function (result) {
                    $("#inputName").val(result.treino.nome);
                    $("#inputDescricao").val(result.treino.descricao);
                    if (result.treino.exercicios) {
                        $(result.treino.exercicios).each(function (i, v) {
                            addRowExercicio(v.treinoExercicioId, v.exercicioId, v.repeticoes);
                        });
                    }
                    
                    addRowExercicio();
                });
            } else {
                addRowExercicio();
            }
        });

        $("#formsub").on("submit", function (e) {
            e.preventDefault();
            let exercicios = [];
            $(`[name="exercicioId[]"]`).each(function (i, v) {
                exercicios.push({
                    id: $(`tr[data-treino-exericico-id]`).eq(i).attr('data-treino-exericico-id'),
                    exercicioId: $(v).val(),
                    repeticoes: $(`[name="repeticoes[]"]`).eq(i).val()
                });
            });
            $.ajax({
                method: currentTreinoId ? "PUT" : "POST",
                url: "http://localhost:60002/v1/treino/" + currentTreinoId,
                data: JSON.stringify({
                    "nome": $("#inputName").val(),
                    "descricao": $("#inputDescricao").val(),
                    "exercicios": exercicios
                }),
                cache: false,
                processData: false,
                contentType: 'application/json',
                headers: {
                    "Authorization": auth.getUserData().jwt
                }
            }).done(function (result) {
                window.location = "/admin/treinos"
            }).fail(function (result) {
                $("#errormessage").html(result.responseJSON.errors[0].message);
            });
        });

        function addRowExercicio(id="", exercicioId="",repeticoes="")
        {
            if (!componentExercicios) {
                component = "<tr><td colspan='2'><i>NENHUM EXERCÍCIO CADASTRADO</i></td></tr>";
            } else {
                component = $(`
                    <tr data-treino-exericico-id="`+id+`">
                        <td>`+componentExercicios+`</td>
                        <td><input type='number' name="repeticoes[]" class="form-control form-control-sm" value="`+repeticoes+`"/></td>
                    </tr>
                `);
    
                if (exercicioId) {
                    component.find('[name="exercicioId[]"]').val(exercicioId);
                }
            }

            $("#listitems").append(component);
        }
    </script>
</body>

</html>