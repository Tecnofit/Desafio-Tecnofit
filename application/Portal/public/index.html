<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.0/font/bootstrap-icons.css">
    <link href="../../src/style.css" rel="stylesheet" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
</head>

<body>
    <header>
        <div class="navbar navbar-dark bg-dark shadow-sm">
            <div class="container">
                <a href="#" class="navbar-brand d-flex align-items-center">
                    <strong>Exercícios do Dia</strong>
                </a>
                <span class="menuitems">
                    <a href="javascript:auth.logout()">Sair</a>
                </span>
            </div>
        </div>
    </header>
    <main>
        <section class="py-5 text-center container">
            <div class="row py-lg-10">
                <div class="col-md-10 mx-auto">
                    <h1 class="fw-light">Bem vindo <span id="spnomealuno"></span></h1>
                    <p class="lead text-muted" id="txtmsg">Execute abaixo os exercícios do seu treino atual</p>
                    <p>
                        <table class="table table-borderless text-start table-striped">
                            <tbody id="listitems"></tbody>
                        </table>
                    </p>
                </div>
            </div>
        </section>
    </main>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="../src/system.js"></script>
    <script>
        document.getElementById("spnomealuno").innerHTML = auth.getUserData().nome;

        $(function () {
            // let currentTreinoId = 'a16dd422-40eb-4c61-8989-a24317d7f05d';

            let currentTreinoId = null;
            let currentAlunoTreinoId = null;
            let exercicios = null;
            let currentTreinoAtivo = false;
            $.ajax({
                method: "GET",
                url: "http://localhost:60002/v1/aluno/"+auth.getUserData().uid+"/treino",
                cache: false,
                processData: false,
                contentType: 'application/json',
                headers: {
                    "Authorization": auth.getUserData().jwt
                },
                async: false
            }).done(function (result) {
                exercicios = result.alunoTreino.exercicios;
                currentTreinoId = result.alunoTreino.treinoId;
                currentAlunoTreinoId = result.alunoTreino.id;
                currentTreinoAtivo = result.alunoTreino.ativo;
            });

            if (!currentTreinoAtivo) {
                $("#txtmsg").html("Você não tem nenhum treino ativo no momento.<br/>Por favor, entre em contato com o seu instrutor.");
                return;
            }

            $.ajax({
                method: "GET",
                url: "http://localhost:60002/v1/treino/" + currentTreinoId,
                cache: false,
                processData: false,
                contentType: 'application/json',
                headers: {
                    "Authorization": auth.getUserData().jwt
                }
            }).done(function (result) {

                $("#inputName").val(result.treino.nome);
                $("#inputDescricao").val(result.treino.descricao);

                if (result.treino.exercicios) {
                    $(result.treino.exercicios).each(function (i, v) {
                        componentRealizar = $(`<div class="component-realizar"><i class="bi-check-circle"></i> Concluir</div>`);
                        componentPular = $(`<div class="component-pular"><i class="bi-dash-circle"></i> Pular</div>`);
                        componentRealizado = $(`<div class="component-realizado"><i class="bi-check-circle-fill"></i> Concluído</div>`);
                        componentIgnorado = $(`<div class="component-ignorado"><i class="bi-dash-circle-fill"></i> Não Realizado</div>`);

                        componentRealizar.on("click", function (e) {
                            e.preventDefault();
                            $.ajax({
                                method: "PUT",
                                url: "http://localhost:60002/v1/aluno/"+auth.getUserData().uid+"/treino/exercicio/status",
                                cache: false,
                                data: JSON.stringify({
                                    "alunoTreinoId": currentAlunoTreinoId,
                                    "alunoTreinoExercicioId": v.treinoExercicioId,
                                    "executado": true
                                }),
                                processData: false,
                                contentType: 'application/json',
                                headers: {
                                    "Authorization": auth.getUserData().jwt
                                }
                            }).done(function (result) {
                                window.location.reload()
                            });
                        });
                        componentPular.on("click", function (e) {
                            e.preventDefault();
                            $.ajax({
                                method: "PUT",
                                url: "http://localhost:60002/v1/aluno/"+auth.getUserData().uid+"/treino/exercicio/status",
                                cache: false,
                                data: JSON.stringify({
                                    "alunoTreinoId": currentAlunoTreinoId,
                                    "alunoTreinoExercicioId": v.treinoExercicioId,
                                    "executado": false
                                }),
                                processData: false,
                                contentType: 'application/json',
                                headers: {
                                    "Authorization": auth.getUserData().jwt
                                }
                            }).done(function (result) {
                                window.location.reload()
                            });
                        });

                        executado = null;
                        exercicioAluno = null;
                        $(exercicios).each(function(a,b) {
                            if (b.treinoExercicioId == v.treinoExercicioId) {
                                executado = b.executado;
                                exercicioAluno = b;
                            }
                        }, exercicios);

                        let sesstext = v.repeticoes != 1 ? "sessões" : "sessão";
                        $("#listitems").append(`
                            <tr data-treino-exercicio-id="`+exercicioAluno.alunoTreinoExercicioId+`">
                                <td style="line-height: 60px; font-size: 26px;">`+v.exercicioNome+`</td>
                                <td style="line-height: 60px; font-size: 26px;">`+v.repeticoes+` `+sesstext+`</td>
                                <td style="text-align: center; width: 280px;" id="rowbtns_`+exercicioAluno.alunoTreinoExercicioId+`"></td>
                            </tr>
                        `);
                        
                        if (executado == true) {
                            $(`#rowbtns_`+exercicioAluno.alunoTreinoExercicioId).append(componentRealizado);
                        } else if (executado == false) {
                            $(`#rowbtns_`+exercicioAluno.alunoTreinoExercicioId).append(componentIgnorado);
                            componentBtns = componentIgnorado[0];
                        } else {
                            $(`#rowbtns_`+exercicioAluno.alunoTreinoExercicioId).append(componentRealizar);
                            $(`#rowbtns_`+exercicioAluno.alunoTreinoExercicioId).append(componentPular);
                        }
                    });
                }
            });
        });
    </script>
</body>

</html>