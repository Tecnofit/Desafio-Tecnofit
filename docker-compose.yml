version: "3.1"
services:

    portal:
      image: nginx:alpine
      container_name: portal
      ports:
       - "80:80"
      volumes:
        - ./application/Portal/public:/application/public
        - ./application/Portal/docker/nginx/confs/nginx.conf:/etc/nginx/conf.d/default.conf
      working_dir:
        /application/public
      command: ["nginx","-g","daemon off;"]
      
    acl-webserver:
      image: acl-nginx:1.0.0
      build:
        context: application/ACL
        dockerfile: docker/nginx/Dockerfile
        args:
          default_port: 60001
          server_name: localhost
          php_container_host: acl
      container_name: acl-webserver
      ports:
       - "60001:60001"
      depends_on:
       - acl

    acl:
      image: acl:1.0.0
      build:
        context: application/ACL
        dockerfile: docker/php-fpm/Dockerfile
      container_name: acl
      working_dir: /application/Main
      volumes:
        - ./application/ACL:/application/Main
        - ./application/Shared:/application/Shared
        - .env:/application/Main/.env
      links:
        - shared-database

    acl-composer:
      image: composer:latest
      container_name: acl-composer
      volumes:
        - ./application/ACL:/var/www/html
        - ./application/ACL/vendor:/var/www/html/vendor
      working_dir: /var/www/html
      command: composer install --ignore-platform-reqs

    gym-webserver:
      image: gym-nginx:1.0.0
      build:
        context: application/Gym
        dockerfile: docker/nginx/Dockerfile
        args:
          default_port: 60002
          server_name: localhost
          php_container_host: gym
      container_name: gym-webserver
      ports:
       - "60002:60002"
      depends_on:
       - gym

    gym:
      image: gym:1.0.0
      build:
        context: application/Gym
        dockerfile: docker/php-fpm/Dockerfile
      container_name: gym
      working_dir: /application/Main
      volumes:
        - ./application/Gym:/application/Main
        - ./application/Shared:/application/Shared
        - .env:/application/Main/.env
      links:
        - shared-database

    gym-composer:
      image: composer:latest
      container_name: gym-composer
      volumes:
        - ./application/Gym:/var/www/html
        - ./application/Gym/vendor:/var/www/html/vendor
      working_dir: /var/www/html
      command: composer install --ignore-platform-reqs

    shared-database:
      image: 'bitnami/mongodb:latest'
      container_name: database
      ports:
        - 60003:27017
      volumes:
        - ./bucket/mongo:/data/db
      environment:
        MONGODB_ROOT_USERNAME: root
        MONGODB_ROOT_PASSWORD: root